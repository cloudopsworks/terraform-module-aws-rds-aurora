name: Terraform AWS RDS Aurora Cluster/DB Module
#logo: logo/logo.jpg

license: "APACHE2"

copyrights:
  - name: "Cloud Ops Works LLC"
    url: "https://cloudops.works"
    year: "2024"

github_repo: cloudopsworks/terraform-module-aws-rds-aurora

description: |-
  Production-ready Terraform module to provision Amazon Aurora (MySQL or PostgreSQL) clusters on AWS.
  Supports provisioned and Serverless v2 engine modes, multi-AZ read replicas, encryption with KMS,
  snapshot-based recovery, and optional managed/rotated master password via AWS Secrets Manager.
  Designed for first-class use with Terragrunt and compatible with common Gruntwork-style boilerplates.

# Introduction to the project
introduction: |-
  This module abstracts the complexity of building secure and scalable Amazon Aurora clusters. It
  exposes a compact input model (settings, vpc, security_groups) with sensible defaults while remaining
  flexible enough for advanced scenarios like global clusters, serverless scaling, snapshot recovery, and
  password rotation. It is cloud-native, tag-aware, and non-intrusive: you can bring your own networking
  and security groups or let the module help with sane defaults.
  
  Integration with Terragrunt is straightforward. If you work with Gruntwork-style scaffolding or any
  similar boilerplate (often stored under a `.boilerplate` directory), you can point your Terragrunt
  configuration at this module and pass inputs using plain HCL maps. This README provides a full usage
  reference and a complete set of Terragrunt examples to get you up and running quickly.

# How to use this project
usage: |-
  This module is designed for Terragrunt-first workflows. Always pin to a release tag (e.g. `?ref=vX.Y.Z`).
  Below is a minimal standalone Terragrunt configuration. See the full Inputs reference and
  additional examples further below.
  
  ```hcl
  terraform {
    source = "git::https://github.com/cloudopsworks/terraform-module-aws-rds-aurora.git?ref=vX.Y.Z"
  }
  
  inputs = {
    settings = {
      name_prefix     = "mydb"
      engine_type     = "aurora-postgresql"
      engine_version  = "15.3"
      instance_size   = "db.r6g.large"
      availability_zones = ["us-east-1a", "us-east-1b"]
      backup = { retention_period = 7 }
      maintenance = { window = "sun:03:00-sun:04:00" }
    }
  
    vpc = {
      vpc_id       = "vpc-xxxxxxxxxxxx"
      subnet_group = "mydb-subnet-group"
      subnet_ids   = ["subnet-aaaa", "subnet-bbbb"]
    }
  
    security_groups = {
      create = false
      name   = "sg-mydb"
    }
  
    org = {
      organization_name = "acme"
      organization_unit = "platform"
      environment_type  = "prod"
      environment_name  = "us-east-1"
    }
  
    extra_tags = { cost_center = "dba" }
    run_hoop   = false
  }
  ```
  
  Inputs reference (Terragrunt `inputs`):
  
  - settings (object map)
  - vpc (object map)
  - security_groups (object map)
  - run_hoop (bool)
  - is_hub (bool), spoke_def (string), org (object), extra_tags (map(string))

  Full variables documentation (YAML with inline comments):

  ```yaml
  # settings:                                      # (Required) Root map for Aurora configuration
  #   recovery:                                    # (Optional) Restore cluster from snapshot or another cluster; conflicts with creating a fresh cluster
  #     enabled: true | false                      # (Optional) Enable recovery mode; default: false
  #     cluster_identifier: "rds-cluster-name"     # (Optional) Source cluster identifier when recovering from another cluster
  #     snapshot_identifier: "cluster-snap-name"   # (Optional) Specific cluster snapshot identifier to restore from
  #   global_cluster:                              # (Optional) Manage Aurora Global Database
  #     create: true | false                       # (Optional) Create a new Global Cluster; default: false
  #     id: "arn:aws:rds:...:global-cluster:mydb" # (Optional) Existing Global Cluster ARN/ID to join; conflicts with create=true
  #   name: "mydb-name"                            # (Optional) Explicit cluster identifier; if set, overrides name_prefix
  #   name_prefix: "mydb"                          # (Required) When `name` not provided; used to build cluster/instances names
  #   database_name: "mydb"                        # (Optional) Initial DB name; default: "cluster_db"; must be null when migration.enabled=true
  #   master_username: "admin"                     # (Optional) Master user name; default: "cluster_root"; must be null when migration.enabled=true
  #   engine_type: "aurora-postgresql"            # (Required) One of: "aurora-postgresql", "aurora-mysql"
  #   engine_version: "15.3"                       # (Required) Aurora engine version (e.g., Postgres 15.x, MySQL 8.0.x supported by AWS)
  #   engine_mode: "provisioned" | "serverless"    # (Optional) Engine mode; for Serverless v2 this is kept as "provisioned" by AWS
  #   auto_minor_upgrade: true | false              # (Optional) Auto minor version upgrade for instances; default: false
  #   availability_zones: ["us-east-1a", "us-east-1b"] # (Required) List of AZs for cluster/instances
  #   rds_port: 5432                                # (Optional) Cluster port; default: 5432 (5432 for PG, 3306 for MySQL typical)
  #   apply_immediately: true | false               # (Optional) Apply changes immediately; default: true
  #   insights_mode: "standard" | "advanced"        # (Optional) Database Insights mode; default: "standard"
  #   publicly_accessible: true | false             # (Optional) Make instances public; default: false
  #   storage:
  #     encryption:
  #       enabled: true | false                     # (Optional) Enable at-rest encryption; default: false
  #       kms_key_id: "1234abcd-..."               # (Optional) Use existing KMS key id
  #       kms_key_arn: "arn:aws:kms:...:key/..."   # (Optional) Use existing KMS key ARN
  #       kms_key_alias: "alias/aws/rds"           # (Optional) Use existing KMS key alias (with or without "alias/" prefix)
  #       deletion_window_in_days: 30               # (Optional) If module creates KMS key; default: 30
  #       rotation_period_in_days: 90               # (Optional) If module creates KMS key; default: 90
  #     type: "" | "aurora-iopt1" | "io1" | "io2" # (Optional) Storage type; defaults to provider/account default; iops required for io1/io2
  #     iops: 1000                                  # (Optional) Required when type is io1/io2
  #   monitoring:
  #     interval: 0                                 # (Optional) Enhanced monitoring interval seconds; one of: 0,1,5,10,15,30,60; default: 0 (disabled)
  #   performance:
  #     enabled: true | false                       # (Optional) Enable Performance Insights; default: false
  #     retention_period: 7                         # (Optional) Retention in days; default: 7
  #     encryption:
  #       enabled: true | false                     # (Optional) Enable encryption for PI; default: false
  #       kms_key_alias: "alias/pi-key"            # (Optional) Existing KMS alias
  #       kms_key_id: "abcd-1234"                  # (Optional) Existing KMS key id
  #       kms_key_arn: "arn:aws:kms:..."           # (Optional) Existing KMS key arn
  #   maintenance:
  #     window: "sun:03:00-sun:04:00"               # (Optional) Preferred maintenance window; default: sun:03:00-sun:04:00
  #   backup:
  #     retention_period: 7                         # (Optional) Snapshot retention days; default: 5
  #     window: "01:00-02:30"                       # (Optional) Preferred backup window; default: 00:45-02:45
  #     copy_tags: true | false                     # (Optional) Copy tags to snapshots; default: true
  #   deletion_protection: true | false             # (Optional) Protect cluster from deletion; default: true
  #   allow_upgrade: true | false                   # (Optional) Allow major version upgrade; default: true
  #   replicas:
  #     count: 2                                    # (Optional) Number of instances; default: 1 (writer only)
  #     replica_0:
  #       availability_zone: "us-east-1a"           # (Optional) AZ override for this replica
  #       promotion_tier: 10                         # (Optional) Lower number = higher failover priority (1-15)
  #       maintenance_window: "wed:03:00-wed:04:00" # (Optional) Per-instance maintenance window
  #     replica_1:
  #       availability_zone: "us-east-1b"           # (Optional)
  #       instance_size: "db.r5.xlarge"             # (Optional) Instance class override for this replica
  #   instance_size: "db.r6g.large" | "db.serverless" # (Required) Instance class; use "db.serverless" for Serverless v1/v2
  #   serverless:
  #     enabled: true | false                        # (Optional) Enable Serverless mode; default: false
  #     v2: true | false                             # (Optional) Use Serverless v2; default: false
  #     scaling_configuration:
  #       min_capacity: 0.5                          # (Optional) Minimum ACU (v2) or capacity (v1)
  #       max_capacity: 16.0                         # (Optional) Maximum ACU (v2) or capacity (v1)
  #       seconds_until_auto_pause: 300              # (Optional) Auto pause after seconds (v1 and v2)
  #       auto_pause: true | false                   # (Optional) v1 only
  #       timeout_action: ForceApplyCapacityChange   # (Optional) v1 only; ForceApplyCapacityChange | RollbackCapacityChange
  #   managed_password: true | false                 # (Optional) Store/manage master password in Secrets Manager; default: false; do not set if migration.enabled=true
  #   managed_password_rotation: true | false        # (Optional) Enable rotation for managed password; default: false
  #   password_secret_kms_key_id: "arn:aws:kms:..." # (Optional) KMS key/alias for the password secret when rotation enabled
  #   rotation_lambda_name: "rds-rotation-lambda"   # (Optional) External rotation Lambda name if not managed by AWS
  #   password_rotation_period: 90                   # (Optional) Rotation period in days; default: 90
  #   rotation_duration: "1h"                        # (Optional) Rotation Lambda duration; default: 1h
  #   iam:
  #     database_authentication_enabled: true | false # (Optional) Enable IAM DB auth; default: true
  #     authentication_roles:                        # (Optional) Attach IAM roles to cluster for auth
  #       - "arn:aws:iam::123456789012:role/role-name"
  #   cloudwatch:
  #     retention_days: 90                           # (Optional) Log retention days; default: 90
  #     retain: true | false                         # (Optional) Prevent log group destroy on delete; default: true
  #     log_exports:
  #       - error
  #       - audit
  #       - general
  #       - iam-db-auth-error
  #       - instance
  #       - postgresql                               # (PostgreSQL)
  #       - slowquery
  #   parameter_group:
  #     create: true | false                         # (Optional) Create dedicated DB parameter group; default: false
  #     family: "aurora-postgresql15"               # (Optional) If not set, computed as engine_type+engine_version
  #     skip_destroy: true | false                   # (Optional) Keep parameter group on destroy; default: false
  #     parameters:
  #       - name: "PARAM NAME"
  #         value: "PARAM VALUE"
  #         apply_method: "immediate" | "pending-reboot"
  #   migration:
  #     enabled: true | false
  #     in_progress: true | false
  #     source_rds_instance: "rds-instance-id"
  #   hoop:
  #     enabled: true | false
  #     agent: "hoop-agent-name"
  #     tags: ["tag1", "tag2"]
  #   events:
  #     enabled: true | false
  #     sns_topic_arn: "arn:aws:sns:...:my-topic"
  #     sns_topic_name: "my-sns-topic"
  #     categories: ["availability", "deletion", "failover", "failure", "low storage", "maintenance", "notification", "read replica", "recovery", "restore", "security", "storage"]
  #     instances: true | false

  # vpc:
  #   vpc_id: "vpc-12345678901234"
  #   subnet_group: "db-subnet-group-name"
  #   subnet_ids:
  #     - "subnet-abcdef123456789"
  #     - "subnet-abcdef123456781"
  #     - "subnet-abcdef123456782"

  # security_groups:
  #   create: true | false
  #   name: "sg-rds"
  #   group_ids:
  #     - "sg-0123456789abcdef0"
  #   allow_cidrs:
  #     - "1.2.3.4/32"
  #     - "10.0.0.0/16"
  #   allow_security_groups:
  #     - "sg-name-123456"
  #     - "sg-name-abcdef"
  ```

# Example usage
examples: |-
  The following Terragrunt examples are based on common Gruntwork-style boilerplates (often generated
  with `terragrunt scaffold` and stored under a `.boilerplate` directory). Adjust include/remote state
  according to your environment.
  
  1) Minimal provisioned Aurora PostgreSQL cluster
  
  ```hcl
  terraform {
    source = "git::https://github.com/cloudopsworks/terraform-module-aws-rds-aurora.git?ref=vX.Y.Z"
  }
  
  inputs = {
    settings = {
      name_prefix        = "mydb"
      engine_type        = "aurora-postgresql"
      engine_version     = "15.3"
      instance_size      = "db.r6g.large"
      availability_zones = ["us-east-1a", "us-east-1b"]
      backup = { retention_period = 7 }
    }
    vpc = {
      vpc_id       = "vpc-xxxxxxxxxxxx"
      subnet_group = "mydb-subnet-group"
      subnet_ids   = ["subnet-aaaa", "subnet-bbbb"]
    }
    security_groups = { create = false, name = "sg-mydb" }
    org = { organization_name = "acme", organization_unit = "platform", environment_type = "prod", environment_name = "us-east-1" }
  }
  ```
  
  2) Serverless v2 Aurora MySQL cluster with scaling limits
  
  ```hcl
  terraform {
    source = "git::https://github.com/cloudopsworks/terraform-module-aws-rds-aurora.git?ref=vX.Y.Z"
  }
  
  inputs = {
    settings = {
      name_prefix        = "srvless"
      engine_type        = "aurora-mysql"
      engine_version     = "8.0.mysql_aurora.3.06.0"
      instance_size      = "db.serverless"
      availability_zones = ["us-east-1a", "us-east-1b"]
      serverless = {
        enabled = true
        v2      = true
        scaling_configuration = {
          min_capacity = 0.5
          max_capacity = 8
        }
      }
      backup = { retention_period = 7 }
    }
    vpc = {
      vpc_id       = "vpc-xxxxxxxxxxxx"
      subnet_group = "srvless-subnets"
    }
    security_groups = { create = false, name = "sg-db-internal" }
    org = { organization_name = "acme", organization_unit = "platform", environment_type = "dev", environment_name = "ue1" }
  }
  ```
  
  3) Recover cluster from snapshot and enable Events to SNS topic
  
  ```hcl
  terraform {
    source = "git::https://github.com/cloudopsworks/terraform-module-aws-rds-aurora.git?ref=vX.Y.Z"
  }
  
  inputs = {
    settings = {
      name_prefix        = "restore"
      engine_type        = "aurora-postgresql"
      engine_version     = "15.3"
      instance_size      = "db.r6g.large"
      availability_zones = ["us-east-1a", "us-east-1b"]
      recovery = {
        enabled             = true
        snapshot_identifier = "mydb-cluster-snap-2024-12-01"
      }
      events = {
        enabled        = true
        sns_topic_name = "aurora-events"
        categories     = ["failover", "maintenance", "failure"]
        instances      = true
      }
    }
    vpc = { vpc_id = "vpc-xxxxxxxxxxxx", subnet_group = "restore-subnets" }
    security_groups = { create = false, name = "sg-db-internal" }
    org = { organization_name = "acme", organization_unit = "platform", environment_type = "staging", environment_name = "ue1" }
  }
  ```
  
  4) Managed master password with rotation and Hoop outputs
  
  ```hcl
  terraform {
    source = "git::https://github.com/cloudopsworks/terraform-module-aws-rds-aurora.git?ref=vX.Y.Z"
  }
  
  inputs = {
    settings = {
      name_prefix        = "secure"
      engine_type        = "aurora-postgresql"
      engine_version     = "15.3"
      instance_size      = "db.r6g.large"
      availability_zones = ["us-east-1a", "us-east-1b"]
      managed_password            = true
      managed_password_rotation   = true
      password_secret_kms_key_id  = "alias/aurora/secrets"
      hoop = {
        enabled = true
        agent   = "corp-agent"
        tags    = ["prod", "aurora"]
      }
    }
    vpc = { vpc_id = "vpc-xxxxxxxxxxxx", subnet_group = "secure-subnets" }
    security_groups = { create = false, name = "sg-db-internal" }
    org = { organization_name = "acme", organization_unit = "platform", environment_type = "prod", environment_name = "ue1" }
    run_hoop = false # set true to run local-exec that creates Hoop connection automatically
  }
  ```

# How to get started quickly
quickstart: |-
  1. Create a new Terragrunt folder (e.g., `live/ue1/prod/aurora`).
  2. Add a `terragrunt.hcl` with the minimal inputs shown above.
  3. Run `terragrunt init` and `terragrunt apply`.
  4. Optionally enable encryption, events, and performance insights as needed.
  
  Minimal inputs (copy/paste):
  
  ```hcl
  terraform {
    source = "git::https://github.com/cloudopsworks/terraform-module-aws-rds-aurora.git?ref=vX.Y.Z"
  }
  inputs = {
    settings = {
      name_prefix        = "mydb"
      engine_type        = "aurora-postgresql"
      engine_version     = "15.3"
      instance_size      = "db.r6g.large"
      availability_zones = ["us-east-1a", "us-east-1b"]
    }
    vpc = { vpc_id = "vpc-xxxxxxxxxxxx", subnet_group = "mydb-subnet-group" }
    security_groups = { create = false, name = "sg-mydb" }
    org = { organization_name = "acme", organization_unit = "platform", environment_type = "prod", environment_name = "ue1" }
  }
  ```
  
  2) Multi-AZ with 2 replicas and per-replica overrides
  
  ```hcl
  terraform { source = "git::https://github.com/cloudopsworks/terraform-module-aws-rds-aurora.git?ref=vX.Y.Z" }
  
  inputs = {
    settings = {
      name_prefix        = "orders"
      engine_type        = "aurora-postgresql"
      engine_version     = "15.3"
      instance_size      = "db.r6g.large"
      availability_zones = ["us-east-1a", "us-east-1b"]
      replicas = {
        count = 2
        replica_0 = {
          availability_zone  = "us-east-1a"
          promotion_tier     = 10
          maintenance_window = "wed:03:00-wed:04:00"
        }
        replica_1 = {
          availability_zone = "us-east-1b"
          promotion_tier    = 15
        }
      }
      backup = { retention_period = 7, copy_tags = true }
      maintenance = { window = "sun:03:00-sun:04:00" }
    }
    vpc = { vpc_id = "vpc-xxxx", subnet_group = "orders-subnet-group", subnet_ids = ["subnet-a", "subnet-b"] }
    security_groups = { create = false, name = "sg-orders" }
  }
  ```
  
  3) Serverless v2 with scaling configuration
  
  ```hcl
  terraform { source = "git::https://github.com/cloudopsworks/terraform-module-aws-rds-aurora.git?ref=vX.Y.Z" }
  
  inputs = {
    settings = {
      name_prefix    = "srvless"
      engine_type    = "aurora-postgresql"
      engine_version = "15.3"
      instance_size  = "db.serverless"
      serverless = {
        enabled = true
        v2      = true
        scaling_configuration = {
          min_capacity = 1
          max_capacity = 10
          seconds_until_auto_pause = 300
        }
      }
      availability_zones = ["us-east-1a", "us-east-1b"]
    }
    vpc = { vpc_id = "vpc-xxxx", subnet_group = "srvless-subnet-group", subnet_ids = ["subnet-a", "subnet-b"] }
    security_groups = { create = false, name = "sg-srvless" }
  }
  ```
  
  4) Restore from latest snapshot of an existing cluster
  
  ```hcl
  terraform { source = "git::https://github.com/cloudopsworks/terraform-module-aws-rds-aurora.git?ref=vX.Y.Z" }
  
  inputs = {
    settings = {
      name_prefix    = "restore"
      engine_type    = "aurora-postgresql"
      engine_version = "15.3"
      instance_size  = "db.r6g.large"
      recovery = {
        enabled            = true
        cluster_identifier = "rds-source-cluster-identifier" # or set snapshot_identifier instead
        # snapshot_identifier = "rds-cluster-snapshot-name"
      }
      availability_zones = ["us-east-1a", "us-east-1b"]
    }
    vpc = { vpc_id = "vpc-xxxx", subnet_group = "restore-subnet-group", subnet_ids = ["subnet-a", "subnet-b"] }
    security_groups = { create = false, name = "sg-restore" }
  }
  ```
  
  5) Managed password in AWS Secrets Manager with rotation
  
  ```hcl
  terraform { source = "git::https://github.com/cloudopsworks/terraform-module-aws-rds-aurora.git?ref=vX.Y.Z" }
  
  inputs = {
    settings = {
      name_prefix                 = "securedb"
      engine_type                 = "aurora-postgresql"
      engine_version              = "15.3"
      instance_size               = "db.r6g.large"
      managed_password            = true
      managed_password_rotation   = true
      password_secret_kms_key_id  = "alias/aws/rds" # or a custom KMS key ARN
      password_rotation_period    = 90
      rotation_duration           = "1h"
      availability_zones          = ["us-east-1a", "us-east-1b"]
    }
    vpc = { vpc_id = "vpc-xxxx", subnet_group = "secure-subnet-group", subnet_ids = ["subnet-a", "subnet-b"] }
    security_groups = { create = false, name = "sg-secure" }
  }
  ```
  
  6) Create a Global Cluster wrapper and attach this cluster
  
  ```hcl
  terraform { source = "git::https://github.com/cloudopsworks/terraform-module-aws-rds-aurora.git?ref=vX.Y.Z" }
  
  inputs = {
    settings = {
      name_prefix    = "globaldb"
      engine_type    = "aurora-postgresql"
      engine_version = "15.3"
      instance_size  = "db.r6g.large"
      global_cluster = {
        create = true
      }
      availability_zones = ["us-east-1a", "us-east-1b"]
    }
    vpc = { vpc_id = "vpc-xxxx", subnet_group = "globaldb-subnet-group", subnet_ids = ["subnet-a", "subnet-b"] }
    security_groups = { create = false, name = "sg-globaldb" }
  }
  ```

# Notes
notes: |-
  - Pin to released tags instead of a moving branch.
  - Networking (VPC/Subnets) and Security Groups are expected to exist unless you opt-in to have them created in your environment wrapper.
  - The module tags resources using your `org` object and `extra_tags` merge strategy.

include:
  - "docs/targets.md"
  - "docs/terraform.md"

contributors:
  - name: "Cristian Beraha"
    github: "berahac"